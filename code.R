###############################
### Part II - Intro to 'sf' ###
###############################

## ------------------------------------------------------------------------
library(sf)

## ------------------------------------------------------------------------
pnt1 = st_point(c(34.812831, 31.260284))

## ------------------------------------------------------------------------
pnt1

## ------------------------------------------------------------------------
class(pnt1)

## ------------------------------------------------------------------------
pnt2 = st_point(c(34.798443, 31.243288))

## ------------------------------------------------------------------------
geom = st_sfc(pnt1, pnt2, crs = 4326)

## ------------------------------------------------------------------------
geom

## ------------------------------------------------------------------------
dat = data.frame(
  name = c("Beer-Sheva North", "Beer-Sheva Center")
)

## ------------------------------------------------------------------------
dat

## ------------------------------------------------------------------------
pnt = st_sf(dat, geom)

## ------------------------------------------------------------------------
pnt

## ------------------------------------------------------------------------
st_geometry(pnt)

## ------------------------------------------------------------------------
st_set_geometry(pnt, NULL)

## ------------------------------------------------------------------------
st_coordinates(pnt)

## ------------------------------------------------------------------------
library(mapview)
# mapview(pnt)

################################
### Part III - Advanced 'sf' ###
################################

## ------------------------------------------------------------------------
# View(st_drivers(what = "vector"))

## ------------------------------------------------------------------------
setwd("~/Dropbox/Presentations/p_2017_08_R_workshop/michael/data/")

## ------------------------------------------------------------------------
states = st_read(
  dsn = "cb_2015_us_state_5m.shp", 
  stringsAsFactors = FALSE
)
tracks = st_read(
  dsn = "hurmjrl020.shp", 
  stringsAsFactors = FALSE
)

## ------------------------------------------------------------------------
dim(states)

## ------------------------------------------------------------------------
plot(states)

## ------------------------------------------------------------------------
dim(tracks)

## ------------------------------------------------------------------------
plot(tracks)

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "grey")

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "grey")
plot(st_geometry(tracks), col = "red", add = TRUE)

## ------------------------------------------------------------------------
# mapview(tracks, zcol = "wind_mph", legend = TRUE)

## ------------------------------------------------------------------------
tracks = tracks[tracks$year > 1949, ]

## ------------------------------------------------------------------------
states = st_transform(states, 2163)
tracks = st_transform(tracks, 2163)

## ------------------------------------------------------------------------
plot(states)

## ------------------------------------------------------------------------
states$area = st_area(states)
states$area[1:3]

## ------------------------------------------------------------------------
class(states$area)

## ------------------------------------------------------------------------
library(units)

states$area = set_units(states$area, km^2)
states$area[1:3]

## ------------------------------------------------------------------------
opar = par()
plot(states[, "area"])
par(opar) 

## ------------------------------------------------------------------------
int = st_intersects(states, states, sparse = FALSE)

## ------------------------------------------------------------------------
int[1:3, 1:3]

## ------------------------------------------------------------------------
states_ctr = st_centroid(states)

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "grey")
plot(st_geometry(states_ctr), col = "red", pch = 3, add = TRUE)

## ------------------------------------------------------------------------
tracks_int = st_intersection(tracks, states)

## ------------------------------------------------------------------------
plot(st_geometry(states), border = "lightgrey")
plot(tracks_int[, "state"], lwd = 3, add = TRUE)

## ------------------------------------------------------------------------
class(tracks_int$geometry)

## ------------------------------------------------------------------------
tracks_int = st_cast(tracks_int, "MULTILINESTRING")

## ------------------------------------------------------------------------
class(tracks_int$geometry)

## ------------------------------------------------------------------------
tracks_int$length = st_length(tracks_int)
tracks_int$length = set_units(tracks_int$length, km)

## ------------------------------------------------------------------------
library(dplyr)

track_lengths = 
  tracks_int %>% 
  st_set_geometry(NULL) %>% 
  group_by(state) %>% 
  summarize(length = sum(length)) %>% 
  as.data.frame

## ------------------------------------------------------------------------
head(track_lengths)

## ------------------------------------------------------------------------
states = merge(
  states, 
  track_lengths, 
  by = "state", 
  all.x = TRUE
)

## ------------------------------------------------------------------------
head(states)

## ------------------------------------------------------------------------
plot(states[, "length"])

## ------------------------------------------------------------------------
states$track_density = states$length / states$area

## ------------------------------------------------------------------------
plot(states[, "track_density"])

## ------------------------------------------------------------------------
plot(states)

###########
### End ###
###########
